name: Release

on:
  push:
    tags:
      - "v*"
  workflow_dispatch:
    inputs:
      version:
        description: "Version to release (e.g., 1.0.0)"
        required: true
        type: string
      draft:
        description: "Create as draft release"
        required: false
        type: boolean
        default: true

# Ensure only one release workflow runs at a time
concurrency:
  group: release-${{ github.ref }}
  cancel-in-progress: false

env:
  # Tauri requires this for consistent builds
  TAURI_SIGNING_PRIVATE_KEY: ${{ secrets.TAURI_SIGNING_PRIVATE_KEY }}
  TAURI_SIGNING_PRIVATE_KEY_PASSWORD: ${{ secrets.TAURI_SIGNING_PRIVATE_KEY_PASSWORD }}

jobs:
  # =============================================================================
  # Pre-release validation
  # =============================================================================
  validate:
    name: Validate Release
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.version.outputs.version }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Extract version
        id: version
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            VERSION="${{ inputs.version }}"
          else
            VERSION="${GITHUB_REF#refs/tags/v}"
          fi
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "Release version: $VERSION"

      - name: Validate version format
        run: |
          VERSION="${{ steps.version.outputs.version }}"
          if ! echo "$VERSION" | grep -qE '^[0-9]+\.[0-9]+\.[0-9]+(-[a-zA-Z0-9.]+)?$'; then
            echo "::error::Invalid version format: $VERSION"
            echo "Expected format: X.Y.Z or X.Y.Z-suffix"
            exit 1
          fi

      - name: Check version consistency
        run: |
          VERSION="${{ steps.version.outputs.version }}"

          # Check tauri.conf.json
          TAURI_VERSION=$(jq -r '.version' apps/gui/src-tauri/tauri.conf.json)
          if [ "$TAURI_VERSION" != "$VERSION" ]; then
            echo "::error::Version mismatch in tauri.conf.json: $TAURI_VERSION (expected $VERSION)"
            exit 1
          fi

          # Check Cargo.toml
          CARGO_VERSION=$(grep '^version' apps/gui/src-tauri/Cargo.toml | head -1 | sed 's/.*"\(.*\)".*/\1/')
          if [ "$CARGO_VERSION" != "$VERSION" ]; then
            echo "::error::Version mismatch in Cargo.toml: $CARGO_VERSION (expected $VERSION)"
            exit 1
          fi

          # Check package.json
          PKG_VERSION=$(jq -r '.version' apps/gui/package.json)
          if [ "$PKG_VERSION" != "$VERSION" ]; then
            echo "::error::Version mismatch in apps/gui/package.json: $PKG_VERSION (expected $VERSION)"
            exit 1
          fi

          echo "All version files are consistent: $VERSION"

  # =============================================================================
  # Run tests before building releases
  # =============================================================================
  test:
    name: Test
    needs: validate
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 9

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "pnpm"

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Build
        run: pnpm build

      - name: Run tests
        run: pnpm test

      - name: Lint
        run: pnpm lint

  # =============================================================================
  # Build for all platforms
  # =============================================================================
  build:
    name: Build (${{ matrix.settings.name }})
    needs: [validate, test]
    strategy:
      fail-fast: false
      matrix:
        settings:
          # Linux x86_64
          - name: Linux x86_64
            os: ubuntu-22.04
            target: x86_64-unknown-linux-gnu
            bundles: deb,appimage,rpm

          # Windows x86_64
          - name: Windows x86_64
            os: windows-latest
            target: x86_64-pc-windows-msvc
            bundles: msi,nsis

          # macOS Intel
          - name: macOS Intel
            os: macos-13
            target: x86_64-apple-darwin
            bundles: dmg,app

          # macOS Apple Silicon
          - name: macOS ARM64
            os: macos-latest
            target: aarch64-apple-darwin
            bundles: dmg,app

    runs-on: ${{ matrix.settings.os }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      # -------------------------------------------------------------------------
      # Setup build environment
      # -------------------------------------------------------------------------
      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 9

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "pnpm"

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: ${{ matrix.settings.target }}

      - name: Rust cache
        uses: Swatinem/rust-cache@v2
        with:
          workspaces: apps/gui/src-tauri
          key: ${{ matrix.settings.target }}

      # -------------------------------------------------------------------------
      # Platform-specific dependencies
      # -------------------------------------------------------------------------
      - name: Install Linux dependencies
        if: runner.os == 'Linux'
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            libwebkit2gtk-4.1-dev \
            libgtk-3-dev \
            libayatana-appindicator3-dev \
            librsvg2-dev \
            patchelf \
            libfuse2

      # -------------------------------------------------------------------------
      # Build application
      # -------------------------------------------------------------------------
      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Turbo cache
        uses: actions/cache@v4
        with:
          path: .turbo
          key: turbo-${{ runner.os }}-${{ matrix.settings.target }}-${{ github.sha }}
          restore-keys: |
            turbo-${{ runner.os }}-${{ matrix.settings.target }}-
            turbo-${{ runner.os }}-

      - name: Build frontend
        run: pnpm build

      - name: Build Tauri app
        run: |
          cd apps/gui
          pnpm tauri build --target ${{ matrix.settings.target }} --bundles ${{ matrix.settings.bundles }}

      # -------------------------------------------------------------------------
      # Upload artifacts
      # -------------------------------------------------------------------------
      - name: Upload Linux artifacts
        if: runner.os == 'Linux'
        uses: actions/upload-artifact@v4
        with:
          name: linux-${{ matrix.settings.target }}
          path: |
            apps/gui/src-tauri/target/${{ matrix.settings.target }}/release/bundle/deb/*.deb
            apps/gui/src-tauri/target/${{ matrix.settings.target }}/release/bundle/appimage/*.AppImage
            apps/gui/src-tauri/target/${{ matrix.settings.target }}/release/bundle/rpm/*.rpm
          if-no-files-found: error

      - name: Upload Windows artifacts
        if: runner.os == 'Windows'
        uses: actions/upload-artifact@v4
        with:
          name: windows-${{ matrix.settings.target }}
          path: |
            apps/gui/src-tauri/target/${{ matrix.settings.target }}/release/bundle/msi/*.msi
            apps/gui/src-tauri/target/${{ matrix.settings.target }}/release/bundle/nsis/*.exe
          if-no-files-found: error

      - name: Upload macOS artifacts
        if: runner.os == 'macOS'
        uses: actions/upload-artifact@v4
        with:
          name: macos-${{ matrix.settings.target }}
          path: |
            apps/gui/src-tauri/target/${{ matrix.settings.target }}/release/bundle/dmg/*.dmg
            apps/gui/src-tauri/target/${{ matrix.settings.target }}/release/bundle/macos/*.app.tar.gz
            apps/gui/src-tauri/target/${{ matrix.settings.target }}/release/bundle/macos/*.app.tar.gz.sig
          if-no-files-found: warn

  # =============================================================================
  # Create GitHub Release
  # =============================================================================
  release:
    name: Create Release
    needs: [validate, build]
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: List artifacts
        run: |
          echo "Downloaded artifacts:"
          find artifacts -type f | sort

      - name: Prepare release assets
        run: |
          mkdir -p release-assets
          VERSION="${{ needs.validate.outputs.version }}"

          # Linux x86_64
          if [ -d "artifacts/linux-x86_64-unknown-linux-gnu" ]; then
            cp artifacts/linux-x86_64-unknown-linux-gnu/deb/*.deb "release-assets/tidy-app_${VERSION}_amd64.deb" 2>/dev/null || true
            cp artifacts/linux-x86_64-unknown-linux-gnu/appimage/*.AppImage "release-assets/tidy-app_${VERSION}_x86_64.AppImage" 2>/dev/null || true
            cp artifacts/linux-x86_64-unknown-linux-gnu/rpm/*.rpm "release-assets/tidy-app-${VERSION}-1.x86_64.rpm" 2>/dev/null || true
          fi

          # Windows x86_64
          if [ -d "artifacts/windows-x86_64-pc-windows-msvc" ]; then
            cp artifacts/windows-x86_64-pc-windows-msvc/msi/*.msi "release-assets/tidy-app_${VERSION}_x64_en-US.msi" 2>/dev/null || true
            cp artifacts/windows-x86_64-pc-windows-msvc/nsis/*.exe "release-assets/tidy-app_${VERSION}_x64-setup.exe" 2>/dev/null || true
          fi

          # macOS Intel
          if [ -d "artifacts/macos-x86_64-apple-darwin" ]; then
            cp artifacts/macos-x86_64-apple-darwin/dmg/*.dmg "release-assets/tidy-app_${VERSION}_x64.dmg" 2>/dev/null || true
            cp artifacts/macos-x86_64-apple-darwin/macos/*.app.tar.gz "release-assets/tidy-app_${VERSION}_x64.app.tar.gz" 2>/dev/null || true
            cp artifacts/macos-x86_64-apple-darwin/macos/*.app.tar.gz.sig "release-assets/tidy-app_${VERSION}_x64.app.tar.gz.sig" 2>/dev/null || true
          fi

          # macOS ARM64
          if [ -d "artifacts/macos-aarch64-apple-darwin" ]; then
            cp artifacts/macos-aarch64-apple-darwin/dmg/*.dmg "release-assets/tidy-app_${VERSION}_aarch64.dmg" 2>/dev/null || true
            cp artifacts/macos-aarch64-apple-darwin/macos/*.app.tar.gz "release-assets/tidy-app_${VERSION}_aarch64.app.tar.gz" 2>/dev/null || true
            cp artifacts/macos-aarch64-apple-darwin/macos/*.app.tar.gz.sig "release-assets/tidy-app_${VERSION}_aarch64.app.tar.gz.sig" 2>/dev/null || true
          fi

          echo "Release assets:"
          ls -la release-assets/

      - name: Generate checksums
        run: |
          cd release-assets
          sha256sum * > checksums-sha256.txt
          echo "Checksums:"
          cat checksums-sha256.txt

      - name: Generate updater manifest (latest.json)
        run: |
          VERSION="${{ needs.validate.outputs.version }}"
          REPO="${{ github.repository }}"
          DATE=$(date -u +"%Y-%m-%dT%H:%M:%SZ")

          # Read signatures if they exist
          MACOS_AARCH64_SIG=""
          MACOS_X64_SIG=""
          WINDOWS_X64_SIG=""
          LINUX_X64_SIG=""

          if [ -f "release-assets/tidy-app_${VERSION}_aarch64.app.tar.gz.sig" ]; then
            MACOS_AARCH64_SIG=$(cat "release-assets/tidy-app_${VERSION}_aarch64.app.tar.gz.sig")
          fi
          if [ -f "release-assets/tidy-app_${VERSION}_x64.app.tar.gz.sig" ]; then
            MACOS_X64_SIG=$(cat "release-assets/tidy-app_${VERSION}_x64.app.tar.gz.sig")
          fi

          # Generate latest.json for Tauri updater
          cat > release-assets/latest.json << EOF
          {
            "version": "${VERSION}",
            "notes": "See the release notes at https://github.com/${REPO}/releases/tag/v${VERSION}",
            "pub_date": "${DATE}",
            "platforms": {
              "darwin-aarch64": {
                "signature": "${MACOS_AARCH64_SIG}",
                "url": "https://github.com/${REPO}/releases/download/v${VERSION}/tidy-app_${VERSION}_aarch64.app.tar.gz"
              },
              "darwin-x86_64": {
                "signature": "${MACOS_X64_SIG}",
                "url": "https://github.com/${REPO}/releases/download/v${VERSION}/tidy-app_${VERSION}_x64.app.tar.gz"
              },
              "linux-x86_64": {
                "signature": "${LINUX_X64_SIG}",
                "url": "https://github.com/${REPO}/releases/download/v${VERSION}/tidy-app_${VERSION}_x86_64.AppImage"
              },
              "windows-x86_64": {
                "signature": "${WINDOWS_X64_SIG}",
                "url": "https://github.com/${REPO}/releases/download/v${VERSION}/tidy-app_${VERSION}_x64-setup.exe"
              }
            }
          }
          EOF

          echo "Generated latest.json:"
          cat release-assets/latest.json

      - name: Create Release
        uses: softprops/action-gh-release@v2
        with:
          name: Tidy App v${{ needs.validate.outputs.version }}
          tag_name: v${{ needs.validate.outputs.version }}
          draft: ${{ github.event.inputs.draft || true }}
          prerelease: ${{ contains(needs.validate.outputs.version, '-') }}
          generate_release_notes: true
          files: |
            release-assets/*
          body: |
            ## Installation

            ### Linux
            - **Debian/Ubuntu**: Download `.deb` file and install with `sudo dpkg -i tidy-app_*.deb`
            - **Fedora/RHEL**: Download `.rpm` file and install with `sudo rpm -i tidy-app-*.rpm`
            - **AppImage**: Download `.AppImage`, make executable with `chmod +x`, and run

            ### macOS
            - **Apple Silicon (M1/M2/M3)**: Download `*_aarch64.dmg`
            - **Intel**: Download `*_x64.dmg`

            ### Windows
            - **MSI Installer**: Download `*.msi` for standard installation
            - **NSIS Installer**: Download `*-setup.exe` for portable installation

            ## Verification

            Verify your download using the checksums in `checksums-sha256.txt`:
            ```bash
            sha256sum -c checksums-sha256.txt --ignore-missing
            ```

  # =============================================================================
  # Update Homebrew Cask (optional, for macOS distribution)
  # =============================================================================
  # homebrew:
  #   name: Update Homebrew
  #   needs: [validate, release]
  #   runs-on: ubuntu-latest
  #   if: ${{ !contains(needs.validate.outputs.version, '-') }}
  #   steps:
  #     - name: Update Homebrew Cask
  #       run: |
  #         echo "TODO: Implement Homebrew cask update"
  #         # This would require a separate Homebrew tap repository
